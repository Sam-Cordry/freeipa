# OpenPGP Key Support

## Overview

Implementation of OpenPGP key storage and related encryption features.

Short feature list:

- PGP Public Key Storage
- escrow for PGP backup keys and encryption keys
- support for PGP keys generated by hardware tokens (like Yubikeys)
- basic keyserver functionality

## Use Cases

- The administrator or the user registers a public PGP key into IPA, associated with a user account.
  The registration process validates the public key in case of erroneous input.
- The user can register a private PGP key into IPA, which can be used to automatically sign or encrypt as needed for
- The administrator or the user can enroll a hardware token, creating a public and a private key associated with a user.

## How to Use

### Registering Public PGP Key

- The administrator or the user provides a public PGP key to become associated with a user.
  This can be done as a part of user account creation or after as an addition to an existing account.

### Registering Private PGP Key

### Enrolling Hardware Token

## Design

This feature makes the following additions to LDAP schema.

```
dn: cn=schema
attributeTypes: (1.3.6.1.4.1.3401.8.2.8 NAME 'pgpBaseKeySpaceDN' DESC 'Points to DN of the object that will store the GPG keys' SYNTAX 1.3.6.1.4.1.1466.115.121.1.12 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.9 NAME 'pgpSoftware' DESC 'Origin of the schema' SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.10 NAME 'pgpVersion' DESC 'Version of the schema' SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.11 NAME 'pgpKey' DESC 'OpenPGP public key block' SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.12 NAME 'pgpCertID' DESC 'OpenPGP long key id' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.13 NAME 'pgpDisabled' DESC 'pgpDisabled attribute for PGP' EQUALITY caseIgnoreMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.14 NAME 'pgpKeyID' DESC 'OpenPGP short key id' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.15 NAME 'pgpKeyType' DESC 'pgpKeyType attribute for PGP' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.16 NAME 'pgpUserID' DESC 'User ID(s) associated with the key' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15)
attributeTypes: (1.3.6.1.4.1.3401.8.2.17 NAME 'pgpKeyCreateTime' DESC 'Primary key creation time' EQUALITY caseIgnoreMatch ORDERING caseIgnoreOrderingMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.18 NAME 'pgpSignerID' DESC 'pgpSignerID attribute for PGP' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15)
attributeTypes: (1.3.6.1.4.1.3401.8.2.19 NAME 'pgpRevoked' DESC 'pgpRevoked attribute for PGP' EQUALITY caseIgnoreMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.3401.8.2.20 NAME 'pgpSubKeyID' DESC 'OpenPGP long Subkey ID(s) of the PGP key' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15)
attributeTypes: (1.3.6.1.4.1.3401.8.2.21 NAME 'pgpKeySize' DESC 'pgpKeySize attribute for PGP' EQUALITY caseIgnoreMatch ORDERING caseIgnoreOrderingMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15)
attributeTypes: (1.3.6.1.4.1.3401.8.2.22 NAME 'pgpKeyExpireTime' DESC 'pgpKeyExpireTime attribute for PGP' EQUALITY caseIgnoreMatch ORDERING caseIgnoreOrderingMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.11591.2.4.1.1 NAME 'gpgFingerprint' DESC 'Fingerprint of the primary key' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 SINGLE-VALUE)
attributeTypes: (1.3.6.1.4.1.11591.2.4.1.2 NAME 'gpgSubFingerprint' DESC 'Fingerprints of the secondary keys' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15)
attributeTypes: (1.3.6.1.4.1.11591.2.4.1.3 NAME 'gpgMailbox' DESC 'The UTF-8 encoded addr-spec of a mailbox' EQUALITY caseIgnoreMatch SUBSTR caseIgnoreSubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.15)
objectClasses: (1.3.6.1.4.1.3401.8.2.23 NAME 'pgpServerInfo' DESC 'An OpenPGP public keyblock store' SUP top STRUCTURAL MUST ( cn $ pgpBaseKeySpaceDN ) MAY ( pgpSoftware $ pgpVersion ) )
objectClasses: (1.3.6.1.4.1.3401.8.2.24 NAME 'pgpKeyInfo' DESC 'An OpenPGP public keyblock' SUP top STRUCTURAL MUST ( pgpCertID $ pgpKey ) MAY ( pgpDisabled $ pgpKeyID $ pgpKeyType $ pgpUserID $ pgpKeyCreateTime $ pgpSignerID $ pgpRevoked $ pgpSubKeyID $ pgpKeySize $ pgpKeyExpireTime $ gpgFingerprint $ gpgSubFingerprint $ gpgMailbox ) )

objectClasses: (1.3.6.1.4.1.3401.8.2.25 NAME 'ipaPgpGroupOfPubKeys' ABSTRACT MAY pgpKey)
objectClasses: (1.3.6.1.4.1.3401.8.2.26 NAME 'ipaPgpUser' SUP ipaPgpGroupOfPubKeys AUXILIARY)
```

## Implementation

This feature does not require any new dependencies or any new files in Backup and Restore.

## Feature Management

### UI

This feature adds an "PGP key" button to the user management page (if you have the appropriate permissions).

### CLI

Additional flags added to some of the user-\* subcommands.

| Command  | (Additional) Flags |
| -------- | ------------------ |
| user-add | --pgppubkey=STR    |
| user-mod | --pgppubkey=STR    |

### Configuration

KRA must be setup in order to store OpenPGP private keys.

## Test plan

Test scenarios that will be transformed to test cases for FreeIPA [Continuous Integration](https://www.freeipa.org/page/V3/Integration_testing) during implementation or review phase. This can be also link to source in [pagure](https://pagure.io/freeipa.git) with the test, if appropriate.

- Key is valid and parsed correctly
- Key is invalid, raising a ValueError
- Key is invalid,
- Key is changed by a user with proper permissions, operation succeeds
- Key is changed by a user without the proper permissions, operation fails

## Troubleshooting and debugging

This feature creates LDAP entries to store OpenPGP public keys and information about them, and relies upon them to fetch that same information on request.
